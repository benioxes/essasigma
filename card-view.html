<!DOCTYPE html>
<html lang="pl">
<head>
    <title>mObywatel</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/card.css?v=1.2">
    <link rel="stylesheet" href="assets/main.css">
    <link rel="icon" type="image/x-icon" href="https://i.imgur.com/U7TRg0V.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/U7TRg0V.png">
    <link rel="shortcut icon" href="https://i.imgur.com/U7TRg0V.png">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
</head>
<body>
    <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #121212; color: white; font-family: sans-serif;">
        <p>Ładowanie dokumentu...</p>
    </div>

    <div id="content" style="display: none;">
        <div class="top_grid">
            <div class="action_grid">
                <img src="https://i.imgur.com/aXIO2NG.png" class="back_img">
                <p class="back_text">mDowód</p>
            </div>
            <p class="title_text">mDowód</p>
            <img src="https://i.imgur.com/VHNv1TC.png" class="help_img">
        </div>

        <div class="bottom_bar">
            <div class="bottom_bar_grid">
                <div class="bottom_element_grid" send="home">
                    <div class="bottom_element_image home_open home"></div>
                    <p class="bottom_element_text open">Dokumenty</p>
                </div>
                <div class="bottom_element_grid" send="services">
                    <div class="bottom_element_image services"></div>
                    <p class="bottom_element_text">Usługi</p>
                </div>
                <div class="bottom_element_grid" send="qr">
                    <div class="bottom_element_image qr"></div>
                    <p class="bottom_element_text">Kod QR</p>
                </div>
                <div class="bottom_element_grid" send="more">
                    <div class="bottom_element_image more"></div>
                    <p class="bottom_element_text">Więcej</p>
                </div>
            </div>
        </div>

        <p class="time_text" id="time"></p>
        <div class="id_image_data">
            <img draggable="false" class="id_image" src="https://i.imgur.com/Ssv8rps.jpeg">
            <div class="inset"></div>
            <div class="id_own_image"></div>
            <img draggable="false" src="https://i.imgur.com/I7oPp72.gif" class="flag_video">
            <img draggable="false" src="https://i.imgur.com/EbBJWYb.gif" class="eagle_video">
            <p class="eagle_text">Rzeczpospolita<br>Polska</p>
            <div class="id_data_grid">
                <div class="data_holder">
                    <p class="data_title firstname" id="name"></p>
                    <p class="data_value">Imię (imiona)</p>
                </div>
                <div class="data_holder">
                    <p class="data_title surname" id="surname"></p>
                    <p class="data_value">Nazwisko</p>
                </div>
                <div class="data_holder">
                    <p class="data_title" id="nationality"></p>
                    <p class="data_value">Obywatelstwo</p>
                </div>
                <div class="data_holder">
                    <p class="data_title" id="birthday"></p>
                    <p class="data_value">Data urodzenia</p>
                </div>
                <div class="data_holder">
                    <p class="data_title" id="pesel"></p>
                    <p class="data_value">Numer PESEL</p>
                </div>
            </div>
        </div>

        <div class="id_bottom">
            <div class="bottom_grid">
                <img class="bottom_image" src="https://i.imgur.com/bdx9fzT.png">
                <p class="bottom_text" style="color: #17bf2d; font-size: 17px;">Dokument ważny</p>
            </div>
        </div>

        <div class="top-buttons">
            <button>
                <div class="icon-circle">
                    <img src="https://i.imgur.com/DGBsoYY.png" alt="Potwierdź">
                </div>
                <span>Potwierdź<br>swoje&nbsp;dane</span>
            </button>
            <button>
                <div class="icon-circle">
                    <img src="https://i.imgur.com/2SPOxrW.png" alt="Dowód">
                </div>
                <span>Dane<br>dowodu<br>osobistego</span>
            </button>
            <button>
                <div class="icon-circle">
                    <img src="https://i.imgur.com/aDXGRtB.png" alt="PESEL">
                </div>
                <span>Zastrzeż PESEL</span>
            </button>
            <button>
                <div class="icon-circle">
                    <img src="https://i.imgur.com/KYGZHxe.png" alt="Więcej">
                </div>
                <span>Pozostałe skróty</span>
            </button>
        </div>

        <div class="card custom-card">
            <div class="field">
                <label>Seria i numer mDowodu</label>
                <div class="value-copy">
                    <div>
                        <b style="font-size:27px" id="mdow_series_display">MWYC 24561</b>
                        <br>
                        <label style="font-size:14px">Dane mDowodu i dowodu<br>osobistego są inne - to dwa różne<br>dokumenty.</label>
                    </div>
                    <button class="value-copy" onclick="copyToClipboard('mdow_series_display')">Kopiuj</button>
                </div>
            </div>
            <div class="field">
                <label>Termin ważności</label>
                <strong id="expiry_date_display">14.07.2028</strong>
            </div>
            <div class="field">
                <label>Data wydania</label>
                <strong id="issue_date_display">14.07.2023</strong>
            </div>
            <div class="field">
                <label>Imię ojca</label>
                <strong id="father_name_display">Maciej</strong>
            </div>
            <div class="field">
                <label>Imię matki</label>
                <strong id="mother_name_display">Ewa</strong>
            </div>
        </div>

        <div class="bottom_holder info_holder">
            <div class="bottom_grid">
                <p class="bottom_text" style="color: var(--font); margin-left: 0px;">Twoje dodatkowe dane</p>
            </div>
            <img class="action_arrow" src="https://i.imgur.com/lTxuUMF.png">
            <div class="additional_holder">
                <div class="additional_grid">
                    <p class="additional_title">Nazwisko rodowe</p>
                    <p class="additional_subtitle" id="familyName"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Płeć</p>
                    <p class="additional_subtitle" id="sex"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Nazwisko rodowe ojca</p>
                    <p class="additional_subtitle" id="fathersFamilyName"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Nazwisko rodowe matki</p>
                    <p class="additional_subtitle" id="mothersFamilyName"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Miejsce urodzenia</p>
                    <p class="additional_subtitle" id="birthPlace"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Kraj urodzenia</p>
                    <p class="additional_subtitle" id="countryOfBirth"></p>
                </div>
                <div class="additional_grid">
                    <p class="additional_title">Adres zameldowania na pobyt stały</p>
                    <p class="additional_subtitle" id="adress"></p>
                </div>
                <div class="additional_grid" style="border-bottom: none;">
                    <p class="additional_title">Data zameldowania na pobyt stały</p>
                    <p class="additional_subtitle" id="home_date_display"></p>
                </div>
            </div>
        </div>

        <div class="bottom_holder" style="height: 90px; margin-bottom: 5px;">
            <div class="bottom_update">
                <div class="bottom_update_grid">
                    <p class="bottom_update_text" style="margin-left: 0px;">Ostatnia aktualizacja</p>
                    <p class="bottom_update_value" style="margin-left: 0px;"></p>
                </div>
                <button class="main_button update">Aktualizuj</button>
            </div>
        </div>
        <div class="bottomtesktern" style="height: 8px; margin-bottom: 120px;"></div>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text);
        }

        async function loadDocument() {
            const API_URL = window.location.origin;
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access');

            if (!accessToken) {
                document.getElementById('loading').innerHTML = '<p style="color: #ff4444;">Brak tokenu dostępu</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/documents/access/${accessToken}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    document.getElementById('loading').innerHTML = `<p style="color: #ff4444;">${error.error || 'Nie można załadować dokumentu'}</p>`;
                    return;
                }
                
                const data = await response.json();
                displayDocument(data);
                
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('loading').innerHTML = '<p style="color: #ff4444;">Błąd podczas ładowania dokumentu</p>';
            }
        }

        function displayDocument(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            let birthday = data.birthday || '';
            if (birthday && birthday.includes('-')) {
                const parts = birthday.split('-');
                birthday = `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            
            // Build URL params from document data and save to sessionStorage
            const newSearch = new URLSearchParams();
            newSearch.set('name', data.name || '');
            newSearch.set('surname', data.surname || '');
            newSearch.set('sex', data.sex || '');
            newSearch.set('birthday', birthday);
            newSearch.set('pesel', data.pesel || '');
            newSearch.set('mdow_series', data.mdow_series || '');
            newSearch.set('issue_date', data.issue_date || '');
            newSearch.set('expiry_date', data.expiry_date || '');
            newSearch.set('father_name', data.father_name || '');
            newSearch.set('mother_name', data.mother_name || '');
            newSearch.set('nationality', data.nationality || '');
            newSearch.set('birthPlace', data.birthPlace || '');
            newSearch.set('countryOfBirth', data.birth_country || '');
            newSearch.set('adress1', data.adress1 || '');
            newSearch.set('adress2', data.adress2 || '');
            newSearch.set('city', data.city || '');
            newSearch.set('home_date', data.home_date || '');
            newSearch.set('familyName', data.family_name || '');
            newSearch.set('fathersFamilyName', data.father_family_name || '');
            newSearch.set('mothersFamilyName', data.mother_family_name || '');
            newSearch.set('image', data.image || '');
            
            // Save to sessionStorage for navigation persistence
            sessionStorage.setItem('docParams', newSearch.toString());
            
            // Also save to localStorage for longer persistence
            localStorage.setItem('documentData', JSON.stringify(data));
            
            // Update URL without access token (replace with actual params)
            window.history.replaceState({}, '', window.location.pathname + '?' + newSearch.toString());

            document.querySelector('.id_own_image').style.backgroundImage = `url(${data.image || ''})`;
            
            document.getElementById('name').textContent = (data.name || '').toUpperCase();
            document.getElementById('surname').textContent = (data.surname || '').toUpperCase();
            document.getElementById('nationality').textContent = (data.nationality || '').toUpperCase();
            document.getElementById('birthday').textContent = birthday;
            document.getElementById('pesel').textContent = data.pesel || '';
            
            document.getElementById('mdow_series_display').textContent = data.mdow_series || '';
            document.getElementById('expiry_date_display').textContent = data.expiry_date || '';
            document.getElementById('issue_date_display').textContent = data.issue_date || '';
            document.getElementById('father_name_display').textContent = data.father_name || '';
            document.getElementById('mother_name_display').textContent = data.mother_name || '';
            
            document.getElementById('familyName').textContent = data.family_name || '';
            document.getElementById('sex').textContent = data.sex || '';
            document.getElementById('fathersFamilyName').textContent = data.father_family_name || '';
            document.getElementById('mothersFamilyName').textContent = data.mother_family_name || '';
            document.getElementById('birthPlace').textContent = data.birthPlace || '';
            document.getElementById('countryOfBirth').textContent = data.birth_country || '';
            document.getElementById('adress').innerHTML = `ul. ${data.adress1 || ''}<br>${data.adress2 || ''} ${data.city || ''}`;
            document.getElementById('home_date_display').textContent = data.home_date || '';
            
            var date = new Date();
            var options = { year: 'numeric', month: 'numeric', day: '2-digit' };
            document.querySelector('.bottom_update_value').textContent = date.toLocaleDateString("pl-PL", options);
            
            setClock();
        }

        function setClock() {
            var date = new Date();
            var options = { year: 'numeric', month: 'numeric', day: '2-digit' };
            var optionsTime = { second: 'numeric', minute: 'numeric', hour: '2-digit' };
            document.getElementById('time').textContent = "Czas: " + date.toLocaleTimeString("pl-PL", optionsTime) + " " + date.toLocaleDateString("pl-PL", options);
            setTimeout(setClock, 1000);
        }

        var unfold = document.querySelector('.info_holder');
        if (unfold) {
            unfold.addEventListener('click', () => {
                unfold.classList.toggle('unfolded');
            });
        }

        var updateBtn = document.querySelector('.update');
        if (updateBtn) {
            updateBtn.addEventListener('click', () => {
                var date = new Date();
                var options = { year: 'numeric', month: 'numeric', day: '2-digit' };
                document.querySelector('.bottom_update_value').textContent = date.toLocaleDateString("pl-PL", options);
                scroll(0, 0);
            });
        }

        loadDocument();
    </script>
    <script src="assets/bar.js"></script>
    <script src="assets/manifest.js"></script>
</body>
</html>
